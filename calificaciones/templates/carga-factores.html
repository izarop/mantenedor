{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Cargar Archivo · Carga x Factor</title>
<link rel="stylesheet" href="{% static 'css/style.css' %}">
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
<style>
  .ref { color: var(--muted); font-size: .9rem; }
  .preview { width:100%; border-collapse: collapse; font-size:.9rem }
  .preview th { background:#f2f2f2; padding:8px; border-bottom:1px solid #ddd; text-align:left }
  .preview td { padding:8px; border-bottom:1px solid #eee }
  .table-wrap { overflow-x:auto; border-radius:8px; box-shadow:0 1px 3px rgba(0,0,0,.1); margin-top:12px }
  .messages { list-style:none; padding:0; margin:0 0 12px 0 }
  .messages li { padding:10px 14px; border-radius:6px; margin-bottom:8px }
  .messages li.error{ background:#ffe6e6; border:1px solid #ffb3b3; color:#8a0000}
  .messages li.success{ background:#e6f7e6; border:1px solid #a9e6a9; color:#2e662e}
  .messages li.info{ background:#e7f1ff; border:1px solid #b8d4ff; color:#003366}
</style>
</head>
<body>

<header class="appbar">
  <div class="brand">NUAM · Mantenedor de Calificaciones Tributarias</div>
  <nav>
    <a href="{% url 'calificacion_list' %}">Listado</a>
  </nav>
</header>

<div class="container">
  <div class="card">
    <div class="card-header">Cargar Archivo · Carga x Factor</div>
    <div class="card-body">

      {% if messages %}
        <ul class="messages">
          {% for message in messages %}
            <li class="{{ message.tags }}">{{ message }}</li>
          {% endfor %}
        </ul>
      {% endif %}

      {# FORMULARIO DE CARGA #}
      <form method="post" enctype="multipart/form-data">
        {% csrf_token %}
        {{ form.archivo.label_tag }} {{ form.archivo }}
        <span class="ref">
          Solo archivos .csv con columnas:
          <b>mercado, origen, instrumento, evento_capital, valor_historico, fecha_pago,
          secuencia_evento, anio, factor_actualizacion, sfut, descripcion, ingreso_por_montos</b>
          y factores <b>f08–f37</b>.
          Cada factor: 0..1, máx 8 decimales. La suma f08..f37 por fila debe ser &gt; 0 y &le; 1.0.
        </span>
        <div class="actions" style="margin-top:12px">
          <button class="btn btn-primary" type="submit">Previsualizar y Validar</button>
          <a class="btn btn-outline" href="#" onclick="cerrarCarga(); return false;">Cancelar</a>


          
          

          <!-- <a class="btn btn-outline" href="#" onclick="window.history.back(); return false;">LOL</a> -->

        </div>
      </form>

      {# TABLA DE ERRORES #}
      {% if invalid_records %}
        <h3 style="margin-top:24px; color:#d9534f">⚠️ Registros Rechazados (Corrija su CSV)</h3>
        <p>Los siguientes registros no cumplen la validación de negocio. Corrija su archivo y vuelva a subirlo.</p>
        <div class="table-wrap">
          <table class="preview">
            <thead>
              <tr>
                <th>Línea CSV</th>
                <th>Error de Validación</th>
              </tr>
            </thead>
            <tbody>
              {% for record in invalid_records %}
              <tr>
                <td>{{ record.linea }}</td>
                <td style="color:#a94442">{{ record.error }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% endif %}

      {# ÚNICA VISTA PREVIA DE REGISTROS VÁLIDOS #}
      {% if preview_html %}
        <h3 style="margin-top:24px">Vista previa del archivo</h3>
        <div class="table-wrap">
          {{ preview_html|safe }}
        </div>
        <form method="post" action="{% url 'confirmar_carga_factores' %}" style="margin-top:12px">
          {% csrf_token %}
          <button class="btn btn-primary" type="submit" href="#">Confirmar Carga</button>
          <a class="btn btn-outline" href="{% url 'carga_factores' %}">Subir otro archivo</a>
        </form>
      {% endif %}
    </div>
  </div>
</div>
<script>
      function cerrarCarga() {
        if (window.parent && window.parent.closeCarga) {
          window.parent.closeCarga();
        } else {
          window.location.href = "{% url 'calificacion_list' %}";
        }
      }
      </script>
</body>
</html>
